<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">

<head>
    <title>17894</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <style type="text/css">
    div.hacker {
        background-color: #666;
        border: 1px solid #ccc;
        color: #fff;
        font-family: "Lucida Console", "Courier New", Courier, fixed;
        font-size: 95%;
        line-height: 160%;
        margin-bottom: 1.5em;
        padding: 10px;
    }
    
    p.note {
        background-color: #ffffe6;
        border: 1px solid #eee;
        color: #666;
        padding: .8em 1.6em;
        margin: 15px 0;
    }
    
    .warning {
        border: 1px #d25100 solid;
        padding: .5em 1em .5em 4em;
        margin: 10px 20px 15px 20px;
        background-image: url(../20150814/@{help-img-path}/img_warning.gif);
        background-repeat: no-repeat;
        background-position: left top;
        background-color: #ededed;
        -moz-border-radius: 0.8em;
        -webkit-border-radius: 0.8em;
        /* -moz-border-bottom-radius: 0;9 */
        -webkit-border-bottom-radius: 0;
        padding-top: 14px;
        padding-bottom: 15px;
    }
    </style>
</head>

<body>

<p>Install  and Configure an EFK stack (Elasticsearch, Fluentd, Kibana) - Ubuntu, Debian,  Logging</p>
<h1>Install and Configure an EFK stack  (Elasticsearch, Fluentd, Kibana) - Ubuntu, Debian </h1>

<p><strong>Difficulty: </strong><em>2</em></p>
<p><strong>Time: </strong> <em>2 hours</em></p>

<p>Use of Elasticsearch, Fluentd, and  Kibana (also known as the EFK stack) is very common when dealing with data  analysis. This combination allows users to collect, index, search, and  visualize log data. In this article, you’ll see steps to install the EFK Stack  (Elasticsearch,  Fluentd and Kibana) on the Ubuntu or Debian platform.</p>

<h2>Overview - Elasticsearch, Fluentd, and Kibana (EFK)</h2>
<h3>Elasticsearch</h3>
<p>Elasticsearch is a popular  search engine used in enterprises. It is based on Apache Lucene, and enables  search and analysis of data in real-time. It is distributed, scalable, and  highly available, making it suitable for all enterprise requirements. It is API  driven platform, and provides support for RESTful API using JSON over HTPP, which  makes it a developer-friendly tool. Additional client libraries are available  for many programming languages. It is available under the Apache 2 licenses,  and thus it can be downloaded, updated and used as desired, without having to  purchase any license. </p>
<h3>Fluentd</h3>
<p>Fluentd is an open source tool,  which acts as a data collector for unified logging layer. It can collect  events from a variety of data sources and writes them to files, including RDBMS,  NoSQL, Cloud based environment (IaaS, SaaS), Hadoop and so on. It has a  pluggable architecture with more than 300+ plugins to connect to various data  sources and data outputs. It is provided with built-in reliability and unified logging  with JSON, making it a simple yet flexible data connectivity tool for most enterprises  use cases. </p>
<h3>Kibana</h3>
<p>Kibana, an open source data analytics and visualization  platform, is developed specifically to work with Elasticsearch. It can be used to  perform data operations such as search, view and other interactions with data stored  in Elasticsearch indices. It also provides advanced data analysis constructs  like charts, tables and maps to help visualize and analyze large volumes of data  in graphical manner.  It provides a browser-based  interface, enabling faster development and sharing of real-time reports. Its  setup requires no additional infrastructure, making it a popular analytics tool  with Elasticsearch.</p>
<h2>Step 1: Install and Configure ElasticSearch</h2>
<p>Login in into the Debian or Ubuntu machine and perform these  steps using the commands described here. It is assumed that you have the sudo  user privileges when performing the following tasks:</p>
<ol>
	<li>Update your Ubuntu or Debian server
		<div class="hacker">
		<pre>sudo apt-get update</pre>
		</div>
	</li>
	<li>Install Java
		<div class="hacker">
		<pre>sudo apt-get install  default-jre</pre>
		</div>
		
		<p>To check Java  version, use the following command</p>
		<div class="hacker">
		<pre>java -version</pre>
		</div> 
	</li>
	<li>Install the Elasticsearch's deb packages (These commands are specific for version 1.2.2. To install the latest version, select the path for lastest version from <a href="http://www.elasticsearch.org/download/" target="_top">elasticsearch.org/download</a>)
		<div class="hacker">
		<pre>sudo wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.2.2.deb</pre>
		<pre>sudo dpkg -i elasticsearch-1.2.2.deb </pre>
		</div>
	</li>
	<li>To make  Elasticseach accessible from public internet, its dynamic scripting needs to be  disabled, so that it can be accessed by the Kibana dashboards. For this, open  the file elasticsearch.yml using the  following command:
		<div class="hacker">
		<pre>sudo vim /etc/elasticsearch/elasticsearch.yml</pre>
		</div>
		<p>Set the  variable script.disable_dynamic to true by appending the below mentioned code at  the end:</p>
		<div class="hacker">
		<pre>script.disable_dynamic: true</pre>
		</div>
	</li>
	<li>Use the following command to start Elasticsearch:
	  <div class="hacker">
	  <pre>sudo service elasticsearch start </pre>
	  </div>
	  <p>Upon successful start, it would show an OK message:<br />
	  <img src="images/17909-Install and Configure an EFK stack (Elasticsearch, Fluentd, Kibana) - Ubuntu, Debian_clip_image002.png" alt="Starting Elasticsearch engine" width="624" height="58" /> </p>
	</li>
</ol>
<h2>Step 2: Install and Configure Kibana</h2>
<ol>
  <li>To install Kibana in your home directory, move  to the home directory
  		<div class="hacker">
		<pre>cd ~</pre>
		</div>
  </li>
  <li>Use following command to install Kibana:
  		<div class="hacker">
		<pre>sudo curl -L https://download.elastic.co/kibana/kibana/kibana-4.1.1-linux-x64.tar.gz | tar xzf -</pre>
  		<pre>sudo cp -r kibana-4.1.1* /usr/share/kibana-4.1.1</pre>
		</div>
  </li>
  <li>By default, Kibana is set to use the port 80 to interact with  Elasticsearch. To update this, update the Kibana’s config.js configuration file.
  		<div class="hacker">
		<pre>sudo vim /usr/share/kibana-4.1.1/config/kibana.yml</pre>
		</div>
  </li>  
  <li>Locate the following code, which is related to the port related setting:
	  <div class="hacker"> 
	  <pre>#default port value is 9200</pre>
	  <pre>elasticsearch: &quot;http://&quot;+window.location.hostname+&quot;:9200&quot;,</pre>
	  </div>
  </li>
  <li>Update this to: 
	  <div class="hacker"> 
	  <pre>#Updated to port value 80</pre>
	  <pre>elasticsearch: &quot;http://&quot;+window.location.hostname+&quot;:80&quot;,</pre>
	  </div>
  </li>
  <li>Nginx can be used as the proxy server. This will enable access to Kibana’s dashboards from Internet. To install Nginx, use the following command:
  	  <div class="hacker"> 
	  <pre>sudo apt-get install nginx --yes</pre>
	  </div>
  </li>
  <li>Create nginx configuration file with the  following command
	  <div class="hacker"> 
	  <pre>sudo rm /etc/nginx/sites-available/default</pre>
	  <pre>sudo vim /etc/nginx/sites-available/default</pre> 
	  </div>
  </li>
  <li>Put the following code inside the nginx cofig file
  	  <div class="hacker"> 
		  <pre>#</pre>
		  <pre># Nginx config file, for setting up Nginx proxy for Elasticsearch + Kibana</pre>
		  <pre>#</pre>
		  <pre># This setup will password protect the saving of dashboards. </pre>
		  <pre># This can be extended for password protection to all paths.</pre>
		  <pre>#</pre>
		  <pre># Even though these paths are being called as the result of an ajax request, the</pre>
		  <pre># browser will prompt for a username/password on the first request</pre>
		  <pre>#</pre>
		  <pre># If you use this, the config.js should point at http://FQDN:80/ instead of</pre>
		  <pre># http://FQDN:9200</pre>
		  <pre>#</pre>
		  <pre>&nbsp;</pre>
		  <pre>server {</pre>
		  <pre> listen                *:80 ;</pre>
		  <pre> server_name           localhost;</pre>
		  <pre> access_log            /var/log/nginx/kibana.log;</pre>
		  <pre> location / </pre>
		  <pre> {</pre>
		  <pre>   root  /usr/share/kibana-4.1.1;</pre>
		  <pre>   index  index.html  index.htm;</pre>
		  <pre> }</pre>
		  <pre> location ~ ^/_aliases$ </pre>
		  <pre> {</pre>
		  <pre>   proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>   proxy_read_timeout 90;</pre>
		  <pre> }</pre>
		  <pre> location ~ ^/.*/_aliases$ </pre>
		  <pre> {</pre>
		  <pre>   proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>   proxy_read_timeout 90;</pre>
		  <pre> }</pre>
		  <pre> location ~ ^/_nodes$ </pre>
		  <pre> { </pre>
		  <pre>   proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>   proxy_read_timeout 90;</pre>
		  <pre>}</pre>
		  <pre> location ~ ^/.*/_search$ </pre>
		  <pre> {</pre>
		  <pre>   proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>   proxy_read_timeout 90;</pre>
		  <pre>}</pre>
		  <pre> location ~ ^/.*/_mapping </pre>
		  <pre> {</pre>
		  <pre>   proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>   proxy_read_timeout 90;</pre>
		  <pre>} </pre>
		  <pre># Password protected end points</pre>
		  <pre>location ~ ^/kibana-int/dashboard/.*$ </pre>
		  <pre> {</pre>
		  <pre>   proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>   proxy_read_timeout 90;</pre>
		  <pre>   limit_except</pre>
		  <pre>   GET</pre>
		  <pre>   { </pre>
		  <pre>    proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>    auth_basic &quot;Restricted&quot;;</pre>
		  <pre>    auth_basic_user_file /etc/nginx/conf.d/kibana.myhost.org.htpasswd;</pre>
		  <pre>   }</pre>
		  <pre>}</pre>
		  <pre> location ~ ^/kibana-int/temp.*$</pre>
		  <pre> {</pre>
		  <pre>   proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>   proxy_read_timeout 90;</pre>
		  <pre>   limit_except GET </pre>
		  <pre>   {</pre>
		  <pre>      proxy_pass http://127.0.0.1:9200;</pre>
		  <pre>      auth_basic &quot;Restricted&quot;;</pre>
		  <pre>      auth_basic_user_file /etc/nginx/conf.d/kibana.myhost.org.htpasswd;</pre>
		  <pre>   }</pre>
		  <pre> }</pre>
		  <pre>}</pre>
  	  </div>
  </li>
  <li>Restart the nginx using the following command:
		<div class="hacker">
		<pre>sudo service nginx restart</pre>
		</div>
  		<p>Upon successful  restart, it would show an OK message:<br />
      <img src="images/17909-Install and Configure an EFK stack (Elasticsearch, Fluentd, Kibana) - Ubuntu, Debian_clip_image004.png" alt="Restarting Elasticsearch engine" width="624" height="53" /></p>
  </li>
</ol>
<h2>Step 3: Install and configure Fluentd</h2>
<ol>
  <li>Install  Fluentd using the following command
	  <div class="hacker">
	  <pre>wget http://packages.treasuredata.com/2/ubuntu/trusty/pool/contrib/t/td-agent/td-agent_2.0.4-0_amd64.deb</pre>
	  <pre>sudo dpkg -i td-agent_2.0.4-0_amd64.deb </pre>
	  </div>
  </li>
  <li>Install  additional plugins. Basically there are two important plugins:
	  <ul>
		<li>out_elasticsearch – To allow Fluentd to stream  data to Elasticsearch</li>
		<li>outrecordreformer – To enable processing of data  into useful formats</li>
	  </ul>
	  <p>Use following commands to install these  plugins:</p>
	  <div class="hacker">
		  <pre>sudo apt-get install make libcurl4-gnutls-dev --yes</pre>
		  <pre>sudo /opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-elasticsearch</pre>
		  <pre>sudo /opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-record-reformer </pre>
	  </div>
  </li>
  <li><p>To allow Fluentd to listen to the syslog  messages and then forward them to Elasticsearch, the configuration file td-agent.conf need to be updated. Open the file using following command:</p>
	  <div class="hacker"> 
	  <pre>sudo vim /etc/td-agent/td-agent.conf</pre>
	  </div>
	  <p>Add the following lines at the top of the  file:</p>
	  <div class="hacker">
		  <pre>&lt;source&gt;</pre>
		  <pre> type syslog</pre>
		  <pre> port 5140</pre>
		  <pre> tag  system</pre>
		  <pre>&lt;/source&gt;</pre>
		  <pre>&lt;match system.*.*&gt;</pre>
		  <pre> type record_reformer</pre>
		  <pre> tag elasticsearch</pre>
		  <pre> facility ${tag_parts[1]}</pre>
		  <pre> severity ${tag_parts[2]}</pre>
		  <pre>&lt;/match&gt;</pre>
		  <pre>&lt;match elasticsearch&gt;</pre>
		  <pre> type copy</pre>
		  <pre> &lt;store&gt;</pre>
		  <pre>   type stdout</pre>
		  <pre> &lt;/store&gt;</pre>
		  <pre> &lt;store&gt;</pre>
		  <pre> type elasticsearch</pre>
		  <pre> logstash_format true</pre>
		  <pre> flush_interval 5s #debug</pre>
		  <pre> &lt;/store&gt;</pre>
		  <pre>&lt;/match&gt; </pre>
	  </div>
	  <p>Save and close the file using ‘:wq’</p>
  </li>
  <li>Start the Fluentd using following command:
   		<div class="hacker">
		<pre>sudo service td-agent start</pre>
		</div>
  </li>
  <li>Redirect  traffic to Fluentd by updating the rsyslog.conf file
	  <div class="hacker">
	  	<pre>sudo vim /etc/rsyslog.conf</pre>
	  </div>
	  	<pre>Add the following line at the top of this file</pre>
	  <div class="hacker">
	  	<pre>*.* @127.0.0.1:5140 </pre>
	  </div>
	  	<pre>Save and exit the editor by pressing Esc key and typing ‘:wq’</pre>
  </li> 
  <li>Restart  the rsyslogd
	   <div class="hacker">
	   <pre>sudo service rsyslog restart </pre>
	   </div>
  </li>
  <h1>Conclusion</h1>
  <p>Using the above procedure,  you can install and prepar the environment for the EFK stack on your Ubuntu or  Debian platform. As an alternative to Fluentd, many users prefer to work with  the Logstash. To know more about the ELK (Elasticsearch, Logstach and Kibana)  stack, and respective steps for installation, see &lt;Link&gt; Install ELK stack (Elasticsearch, Logstash, Kibana) on your Ubuntu or Debian  platform. </p>
</li>
</ol>

</body>
</html>
